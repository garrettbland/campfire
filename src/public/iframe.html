<html>
    <head>
        <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>


            <!-- Latest Sortable -->
            <script src="https://raw.githack.com/SortableJS/Sortable/master/Sortable.js"></script>

        <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Nunito&display=swap" rel="stylesheet">
        <style>
            * {
                font-family: 'Nunito', sans-serif;
            }
        </style>
        <!-- <link href="https://fonts.googleapis.com/css?family=Jost:400,500,700&display=swap" rel="stylesheet">
        <style>
            * {
                font-family: 'Jost', sans-serif;
            }
        </style> -->
        <title>
            Your website
        </title>
        <style>
            .auto-fit {
                height: fit-content;
            }

            *[contenteditable=true]:focus {
                outline: none;
            }

            h1:hover {
                outline: 1px solid red;
                outline-offset: 1px;
                cursor:text;
            }
            h1:focus {
                outline: 1px solid blue;
                outline-offset: 1px;
            }

            h1[contenteditable=true]:empty::before {
                content: attr(placeholder);
                opacity: 0.5;
            }
            p:hover {
                outline: 1px solid red;
                outline-offset: 1px;
                cursor:text;
            }
            p:focus {
                outline: 1px solid blue;
                outline-offset: 1px;
            }

            p[contenteditable=true]:empty::before {
                content: attr(placeholder);
                opacity: 0.5;
            }

            #activeElement {
                outline: 1px solid blue;
                outline-offset: 1px;
            }

            li[contenteditable=true]:empty::before {
                content: attr(placeholder);
                opacity: 0.5;
            }
        </style>
    </head>
    <body class="auto-fit">
        <div x-data="campfire()" x-init="listenerer()" x-on:keydown="enterListen" x-on:paste="OnPaste_StripFormatting(this, event);">
            <div x-show="elementSelected" class="flex h-12">
                <button x-on:click="changeColor('red')" class="mr-4">
                    Make red
                </button>
                <button x-on:click="changeFont('serif')" class="mr-4">
                    Change Font
                </button>
                <button x-show="textSelected" x-on:click="formatCommand('bold')">
                    Make Bold
                </button>
            </div>
            <div id="testId">
                <style>
                    ul > li {
                        color:red
                    }
                </style>
                <section class="py-12 p-4 bg-white relative">
                    <!-- <button x-on:click="editBackground(event)" class="absolute top-0 right-0 bg-green-500">
                        Edit background
                    </button> -->
                    <div class="max-w-4xl mx-auto">
                        <div class="text-center">
                            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold leading-tight">
                                Your website title
                            </h1>
                        </div>
                        <div class="text-lg md:text-xl text-gray-600 text-center">
                            <p>
                                Describe your website here in however many words you want to. This
                                is a short description.Describe your website here in however many words you want to. This
                                is a short description
                            </p>
                        </div>
                        <div class="mt-6 flex justify-center">
                            <a id="testlink" class="w-full md:w-auto bg-blue-600 text-blue-100 px-8 py-3 rounded shadow-md text-center">
                                Sign Up
                            </a>
                        </div>
                    </div>
                </section>
                <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center my-12">
                        <p class="text-lg font-bold">
                            Feature 1
                        </p>
                        <p>
                            This is a description of the feature
                        </p>
                    </div>
                    <div class="text-center my-12">
                        <p class="text-lg font-bold">
                            Feature 2
                        </p>
                        <p>
                            This is a description of the feature
                        </p>
                    </div>
                    <div class="text-center my-12">
                        <p class="text-lg font-bold">
                            Feature 3
                        </p>
                        <p>
                            This is a description of the feature
                        </p>
                    </div>
                </section>
                <section class="grid grid-cols-1 gap-4">
                    <div class="my-12">
                        <p class="text-2xl font-bold">
                            List Items
                            <ul>
                                <li>Item 1</li>
                                <li>Item 2</li>
                            </ul>
                            And more text content
                        </p>
                        <img class="w-full sm:w-full md:w-1/2" src="https://images.unsplash.com/photo-1548681528-6a5c45b66b42?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=668&q=80"/>
                    </div>
                </section>
            </div>
        </div>
        <script>
            var _onPaste_StripFormatting_IEPaste = false;
            function campfire() {
                return {
                    elementSelected: false,
                    textSelected: false,
                    OnPaste_StripFormatting: function (elem, e) {
                        if (e.originalEvent && e.originalEvent.clipboardData && e.originalEvent.clipboardData.getData) {
                            e.preventDefault();
                            var text = e.originalEvent.clipboardData.getData('text/plain');
                            window.document.execCommand('insertText', false, text);
                        }
                        else if (e.clipboardData && e.clipboardData.getData) {
                            e.preventDefault();
                            var text = e.clipboardData.getData('text/plain');
                            window.document.execCommand('insertText', false, text);
                        }
                        else if (window.clipboardData && window.clipboardData.getData) {
                            // Stop stack overflow
                            if (!_onPaste_StripFormatting_IEPaste) {
                                _onPaste_StripFormatting_IEPaste = true;
                                e.preventDefault();
                                window.document.execCommand('ms-pasteTextOnly', false);
                            }
                            _onPaste_StripFormatting_IEPaste = false;
                        }
                    },
                    changeColor: function (color) {
                        console.log('change color of active element')
                        document.getElementById('activeElement').style.color = color
                    },
                    changeFont: function (family) {
                        console.log('change font of active element')
                        document.getElementById('activeElement').style.fontFamily = family
                    },
                    formatCommand: function (command) {
                        document.execCommand(command)
                    },
                    selectionIsBold: function () {
                        var isBold = false;
                        if (document.queryCommandState) {
                            isBold = document.queryCommandState("bold");
                        }
                        return isBold;
                    },
                    removeWhiteSpaces: function (element) {
                        // takes in docuemnt id and removes white spaces between html tags
                        element.innerHTML = element.innerHTML.replace(/>\s+</g, "><")
                    },
                    preventEvent: function (event) {
                        window.alert('test')
                        event.preventDefault()
                    },
                    removeAllActiveElementIds: function (id) {
                        var activeElements = document.querySelectorAll(id)
                        var i
                        for (i = 0; i < activeElements.length; i++) {
                            activeElements[i].removeAttribute('id','activeElement')
                        }
                    },
                    addEditBackgroundButtons: function () {
                        var sections = document.getElementsByTagName("SECTION")

                        var id;
                        for (id = 0; id < sections.length; id++) {
                            var editButton = document.createElement('button')
                            editButton.setAttribute('x-on:click', 'editBackground(event)')
                            editButton.setAttribute('class', 'bg-green-500 absolute top-0 right-0')
                            editButton.setAttribute('id','dragHandle')
                            editButton.innerText = 'Edit Background'
                            sections[id].classList.add('relative')
                            sections[id].appendChild(editButton)
                        }
                    },
                    editBackground: function (event) {
                        //window.alert("edit the background" + event.target.localName)
                        //event.target.parentElement.style.backgroundColor = 'red'

                        let backgroundimage = window.prompt('new background image url')
                        event.target.parentElement.classList.add('bg-cover')
                        event.target.parentElement.classList.add('bg-center')
                        event.target.parentElement.style.backgroundImage = 'url('+backgroundimage+')'


                    },
                    enterListen: function (event) {

                        // // returnable elements
                        // var returnEnabled = ['p','li']
                        // var currentlySelected = document.getElementById('activeElement')

                        // // listens for enter key being pressed
                        // var code = (event.keyCode ? event.keyCode : event.which)
                        // if (code === 13) {
                        //     // enter key was pressed
                        //     if (returnEnabled.includes(currentlySelected.localName)) {
                        //         // allow returns
                        //         //document.execCommand('insertHTML', false, '<br>')
                        //         return
                        //     } else {
                        //         event.preventDefault()
                        //     }
                        // }

                    },
                    listenerer: function (event) {
                        var _this = this

                        // replace white space
                        var link = document.getElementById('testlink').innerHTML
                        var newlink = link.replace(/(<(pre|script|style|textarea)[^]+?<\/\2)|(^|>)\s+|\s+(?=<|$)/g, "$1$3")
                        document.getElementById('testlink').innerHTML = newlink

                        console.log(newlink)

                        // ignore elements
                        var ignoreElements = ['button']

                        // editable elements
                        var editableElements = ['h1','h2','h3','p','li', 'a']

                        // make return button add a p tag
                        document.execCommand('defaultParagraphSeparator', false, 'p')

                        // add edit background buttons to sections
                        _this.addEditBackgroundButtons()

                        // sortable
                         // List with handle
                            Sortable.create(testId, {
                                handle: '#dragHandle',
                                animation: 150
                            });

                        document.getElementById('testId').addEventListener('keydown', function (event) {

                            console.log(event)

                            // handle delete key for lists
                            if(event.keyCode === 8 && event.target.localName === 'li') {
                                console.log('deleted pressed ==>')
                                if(event.target.innerText === '') {
                                    console.log('text is empty')
                                    console.log(event.target.previousElementSibling)
                                    if(event.target.previousElementSibling) {
                                        console.log("EMPTY LI")



                                        var range = document.createRange();
                                        var sel = window.getSelection();

                                        // get lenth of child nodes
                                        var childNodes = event.target.previousElementSibling.childNodes.length

                                        if(childNodes === 1) {
                                            childNodes = 0
                                        }

                                        // get length of last child text node
                                        var lastChildTextLength = event.target.previousElementSibling.childNodes[childNodes].length


                                        console.log(childNodes)

                                        event.target.previousElementSibling.innerHTML = event.target.previousElementSibling.innerHTML + '&nbsp'


                                        range.setStart(event.target.previousElementSibling.childNodes[childNodes], lastChildTextLength + 1);
                                        range.collapse(true);
                                        sel.removeAllRanges();
                                        sel.addRange(range);
                                        event.target.previousElementSibling.focus();



                                        event.target.remove()

                                    }
                                }
                            }

                            if(event.keyCode === 13) {

                                console.log("HANDLE RETURN KEY HERE")

                                if(event.target.localName === 'p' || event.target.localName === 'li') {

                                    if(event.target.localName === 'li') {
                                        event.preventDefault()
                                    // dont allow empty <li>'s
                                        if(event.target.innerText !== '') {
                                        //document.execCommand('insertHTML', false, '<li></li>')
                                        _this.removeAllActiveElementIds('#activeElement')

                                        var new_li = document.createElement("li")
                                        new_li.setAttribute('contenteditable', true)
                                        new_li.setAttribute('placeholder','...')
                                        //new_li.innerText = 'new item'
                                        new_li.setAttribute('id', 'activeElement')
                                        // event.target.parentElement.appendChild(new_li)

                                        // this works but isn't supported in IE or Edge
                                        //event.target.after(new_li)

                                        if (event.target.nextSibling) {
                                            event.target.parentNode.insertBefore(new_li, event.target.nextSibling);
                                        }
                                        else {
                                            event.target.parentNode.appendChild(new_li);
                                        }

                                    // document.getElementById('activeElement').focus()

                                    console.log(document.getElementById('activeElement'))

                                        var el = document.getElementById("activeElement");
                                        var range = document.createRange();
                                        var sel = window.getSelection();
                                        console.log(range)
                                        console.log(sel)
                                        range.setStart(el, 0);
                                        range.collapse(true);
                                        sel.removeAllRanges();
                                        sel.addRange(range);
                                        el.focus();


                                    }
                                    }
                                } else {
                                    event.preventDefault()
                                }

                            } else {
                                return
                            }
                        })


                        // add listener for editable elements mouseoer to enable content editable
                        document.addEventListener('mouseover', function (event) {

                            var localName = event.target.localName
                            var parentName = event.target.parentElement.localName

                            if(ignoreElements.includes(localName)) {

                            } else if (editableElements.includes(localName) || editableElements.includes(parentName)) {

                                // add content editable to edit element
                                event.target.setAttribute('contenteditable',true)

                                // add placeholder
                                if(editableElements.includes(localName)) {
                                    event.target.setAttribute('placeholder','...')
                                } else {
                                    event.target.parentElement.setAttribute('placeholder','....')
                                }

                            }

                        })

                        document.addEventListener('click', function (event) {

                            console.log(event.target.parentElement.localName)

                            var localName = event.target.localName
                            var parentName = event.target.parentElement.localName
                            var grandParentName = event.target.parentElement.parentElement.localName

                            // inner editable elements
                            //var innerEditableElements = ['span','b','i']

                            if(ignoreElements.includes(localName)) {
                                // do nothing
                                console.log('doing nothing ==> ' +localName)
                            } else if (localName === 'img') {
                                var newURL = window.prompt('New image url')
                                event.target.src = newURL;
                            } else if (editableElements.includes(localName) || editableElements.includes(parentName)) {

                                _this.removeAllActiveElementIds('#activeElement')
                                console.log('clicked on editabled element ==> ' +localName)
                                _this.elementSelected = true

                                // this is used to check if a span or something is selected so it
                                // doesn't style just that <span> or <b> tag. Start with grandparent element, and then parent, and then element. This is for p tags within p tags or the b,span,i tags within a child p tag.
                                if (editableElements.includes(grandParentName)) {
                                    event.target.parentElement.parentElement.setAttribute('id','activeElement')
                                } else if(editableElements.includes(parentName)) {
                                    event.target.parentElement.setAttribute('id','activeElement')
                                } else {
                                    event.target.setAttribute('id','activeElement')
                                }

                                // check if text is selected
                                var selectionObj = window.getSelection()
                                var selectedText = selectionObj.toString()
                                if(selectedText.length > 0) {
                                    console.log(_this.selectionIsBold())
                                    _this.textSelected = true
                                } else {
                                    _this.textSelected = false
                                }
                                //console.log(selectionObj.getRangeAt(0))

                            } else {
                                console.log('ignoring all ==> '+localName)
                                _this.removeAllActiveElementIds('#activeElement')
                                _this.elementSelected = false
                            }
                        })
                    }
                }
            }
        </script>
    </body>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/iframe-resizer/4.2.10/iframeResizer.contentWindow.min.js'></script>
</html>